name: MLOps Pipeline with DVC

on:
  push:
    branches:
      - main
    paths:
      - 'data/raw/crime_Data_*.csv'  # Trigger sur nouveau raw data
  workflow_dispatch:
    inputs:
      year:
        description: 'Année à traiter (ex: 2021)'
        required: true

jobs:
  pipeline:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install dvc dvc[all]  # ou dvc[s3] si tu utilises S3

      - name: Configure DVC
        env:
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          dvc remote modify origin --local auth basic
          dvc remote modify origin --local password $DAGSHUB_TOKEN
          dvc remote modify origin --local user benrhoumamohamed752

      - name: Pull DVC data
        run: dvc pull

      - name: Preprocess new data
        run: python src/data/preprocessing.py --year ${{ inputs.year || 2021 }}

      - name: Add processed to DVC
        run: |
          dvc add data/processed/crime_${{ inputs.year || 2021 }}_processed.csv
          git add data/processed/crime_${{ inputs.year || 2021 }}_processed.csv.dvc

      - name: Detect drift
        id: drift
        run: |
          python src/monitoring/drift_detection.py --old_year 2020 --new_year ${{ inputs.year || 2021 }}
          echo "drift_detected=$(python -c "import os; print(os.getenv('drift_detected', 'False'))")" >> $GITHUB_OUTPUT

      - name: Retrain if drift
        if: steps.drift.outputs.drift_detected == 'True'
        run: |
          python src/models/train.py --data data/processed/crime_${{ inputs.year || 2021 }}_processed.csv --model random_forest
          python src/models/train.py --data data/processed/crime_${{ inputs.year || 2021 }}_processed.csv --model xgboost
          python src/models/train.py --data data/processed/crime_${{ inputs.year || 2021 }}_processed.csv --model lightgbm
          python src/models/ensemble.py --data data/processed/crime_${{ inputs.year || 2021 }}_processed.csv --ensemble both
          python src/models/promote_best_model.py --auto_promote

      - name: Commit & Push DVC changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add .
          git commit -m "Update processed data and model for year ${{ inputs.year || 2021 }} [ci skip]" || echo "Nothing to commit"
          git push
          dvc push