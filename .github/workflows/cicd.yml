name: MLOps Pipeline with DVC - Crime Prediction

on:
  push:
    branches:
      - main
    paths:
      - 'data/raw/*.csv.dvc'
      - 'src/**'
      - '.github/workflows/**'
  
  workflow_dispatch:
    inputs:
      year:
        description: 'Ann√©e √† traiter (ex: 2022)'
        required: true
        default: '2022'
      force_retrain:
        description: 'Forcer le r√©entra√Ænement'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.10'
  DAGSHUB_USER: benrhoumamohamed752
  DAGSHUB_REPO: ProjetMLOps

jobs:
  setup:
    name: üîß Setup & DVC Config
    runs-on: ubuntu-latest
    outputs:
      year: ${{ steps.determine_year.outputs.year }}
      should_continue: ${{ steps.validate.outputs.should_continue }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: üì¶ Install DVC
        run: pip install dvc[all]
      
      - name: üîê Configure DVC
        env:
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          dvc remote modify origin --local auth basic
          dvc remote modify origin --local user ${{ env.DAGSHUB_USER }}
          dvc remote modify origin --local password $DAGSHUB_TOKEN
      
      - name: üìÖ Determine Year
        id: determine_year
        run: |
          YEAR=${{ inputs.year || '2022' }}
          echo "year=$YEAR" >> $GITHUB_OUTPUT
          echo "üóìÔ∏è Ann√©e : $YEAR"
      
      - name: üì• Pull Raw Data
        run: |
          YEAR=${{ steps.determine_year.outputs.year }}
          dvc pull data/raw/crime_Data_${YEAR}.csv.dvc
          ls -lh data/raw/crime_Data_${YEAR}.csv
      
      - name: ‚úÖ Validate
        id: validate
        run: |
          YEAR=${{ steps.determine_year.outputs.year }}
          FILE="data/raw/crime_Data_${YEAR}.csv"
          
          if [ -f "$FILE" ] && [ $(wc -l < "$FILE") -gt 100 ]; then
            echo "should_continue=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Validation OK"
          else
            echo "should_continue=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  preprocessing:
    name: üìä Preprocessing
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.should_continue == 'true'
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - run: pip install pandas numpy scikit-learn joblib dvc[all]
      
      - name: üîê Configure DVC
        env:
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          dvc remote modify origin --local auth basic
          dvc remote modify origin --local user ${{ env.DAGSHUB_USER }}
          dvc remote modify origin --local password $DAGSHUB_TOKEN
      
      - name: üì• Pull Raw Data
        run: |
          YEAR=${{ needs.setup.outputs.year }}
          dvc pull data/raw/crime_Data_${YEAR}.csv.dvc
      
      - name: üîß Preprocess
        run: |
          YEAR=${{ needs.setup.outputs.year }}
          python src/data/preprocessing.py --year $YEAR
      
      - name: üì§ Add to DVC
        run: |
          YEAR=${{ needs.setup.outputs.year }}
          dvc add data/processed/crime_${YEAR}_processed.csv
      
      - uses: actions/upload-artifact@v4
        with:
          name: processed-${{ needs.setup.outputs.year }}
          path: |
            data/processed/crime_${{ needs.setup.outputs.year }}_processed.csv
            data/processed/crime_${{ needs.setup.outputs.year }}_processed.csv.dvc

  drift_detection:
    name: üîç Drift Detection
    runs-on: ubuntu-latest
    needs: [setup, preprocessing]
    outputs:
      drift_detected: ${{ steps.drift.outputs.drift_detected }}
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - run: pip install pandas numpy scipy evidently dvc[all]
      
      - name: üîê Configure DVC
        env:
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          dvc remote modify origin --local auth basic
          dvc remote modify origin --local user ${{ env.DAGSHUB_USER }}
          dvc remote modify origin --local password $DAGSHUB_TOKEN
      
      - uses: actions/download-artifact@v4
        with:
          name: processed-${{ needs.setup.outputs.year }}
          path: data/processed
      
      - name: üì• Pull Previous Year
        run: |
          YEAR=${{ needs.setup.outputs.year }}
          OLD_YEAR=$((YEAR - 1))
          dvc pull data/processed/crime_${OLD_YEAR}_processed.csv.dvc || echo "No old data"
      
      - name: üîç Detect Drift
        id: drift
        run: |
          YEAR=${{ needs.setup.outputs.year }}
          OLD_YEAR=$((YEAR - 1))
          
          if [ -f "data/processed/crime_${OLD_YEAR}_processed.csv" ]; then
            python src/monitoring/drift_detection.py --old_year $OLD_YEAR --new_year $YEAR
          else
            echo "drift_detected=true" >> $GITHUB_OUTPUT
          fi

  training:
    name: ü§ñ Training
    runs-on: ubuntu-latest
    needs: [setup, preprocessing, drift_detection]
    if: needs.drift_detection.outputs.drift_detected == 'true' || inputs.force_retrain
    strategy:
      matrix:
        model: [random_forest, xgboost, lightgbm, logistic_regression]
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - run: pip install -r requirements.txt
      
      - uses: actions/download-artifact@v4
        with:
          name: processed-${{ needs.setup.outputs.year }}
          path: data/processed
      
      - name: üîê Configure DagsHub
        env:
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          mkdir -p ~/.dagshub
          echo "$DAGSHUB_TOKEN" > ~/.dagshub/token
      
      - name: ü§ñ Train
        env:
          MLFLOW_TRACKING_URI: https://dagshub.com/${{ env.DAGSHUB_USER }}/${{ env.DAGSHUB_REPO }}.mlflow
          MLFLOW_TRACKING_USERNAME: ${{ env.DAGSHUB_USER }}
          MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          YEAR=${{ needs.setup.outputs.year }}
          python src/models/train.py --data data/processed/crime_${YEAR}_processed.csv --model ${{ matrix.model }}

  ensemble:
    name: üéØ Ensemble
    runs-on: ubuntu-latest
    needs: [setup, training]
    if: needs.training.result == 'success'
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - run: pip install -r requirements.txt
      
      - uses: actions/download-artifact@v4
        with:
          name: processed-${{ needs.setup.outputs.year }}
          path: data/processed
      
      - name: üîê Configure DagsHub
        env:
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          mkdir -p ~/.dagshub
          echo "$DAGSHUB_TOKEN" > ~/.dagshub/token
      
      - name: üéØ Train Ensemble
        env:
          MLFLOW_TRACKING_URI: https://dagshub.com/${{ env.DAGSHUB_USER }}/${{ env.DAGSHUB_REPO }}.mlflow
          MLFLOW_TRACKING_USERNAME: ${{ env.DAGSHUB_USER }}
          MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          YEAR=${{ needs.setup.outputs.year }}
          python src/models/ensemble.py --data data/processed/crime_${YEAR}_processed.csv --ensemble both

  model_selection:
    name: üèÜ Selection
    runs-on: ubuntu-latest
    needs: [setup, ensemble]
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - run: pip install mlflow dagshub pandas
      
      - name: üîê Configure DagsHub
        env:
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          mkdir -p ~/.dagshub
          echo "$DAGSHUB_TOKEN" > ~/.dagshub/token
      
      - name: üèÜ Compare & Promote
        env:
          MLFLOW_TRACKING_URI: https://dagshub.com/${{ env.DAGSHUB_USER }}/${{ env.DAGSHUB_REPO }}.mlflow
          MLFLOW_TRACKING_USERNAME: ${{ env.DAGSHUB_USER }}
          MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}
        run: python src/models/compare_all_models.py --save --auto_promote

  commit_dvc:
    name: üíæ Commit DVC
    runs-on: ubuntu-latest
    needs: [setup, preprocessing, model_selection]
    if: needs.preprocessing.result == 'success'
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - run: pip install dvc[all]
      
      - name: üîê Configure DVC
        env:
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          dvc remote modify origin --local auth basic
          dvc remote modify origin --local user ${{ env.DAGSHUB_USER }}
          dvc remote modify origin --local password $DAGSHUB_TOKEN
      
      - uses: actions/download-artifact@v4
        with:
          name: processed-${{ needs.setup.outputs.year }}
          path: data/processed
      
      - name: üì§ Push DVC
        run: |
          YEAR=${{ needs.setup.outputs.year }}
          dvc push data/processed/crime_${YEAR}_processed.csv.dvc || echo "DVC push failed"
      
      - name: üì§ Commit Git
        run: |
          YEAR=${{ needs.setup.outputs.year }}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/processed/*.dvc .gitignore reports/ || true
          git commit -m "ü§ñ Update DVC data for ${YEAR} [skip ci]" || echo "Nothing"
          git push || echo "Nothing"
